# 子查询(SQL Subquery)知识点总结

子查询是SQL中非常重要的概念，它允许你在一个查询中嵌套另一个查询。以下是子查询相关的核心知识点和常用语句：

## 一、子查询基础概念

1. **定义**：子查询是嵌套在另一个SQL查询(如SELECT, INSERT, UPDATE, DELETE)中的查询。
2. **分类**：
   - 按位置分：WHERE子句子查询、FROM子句子查询、SELECT子句子查询
   - 按返回结果分：标量子查询(返回单个值)、列子查询(返回一列)、行子查询(返回一行)、表子查询(返回多行多列)

## 二、常用子查询语句

### 1. WHERE子句中的子查询

```sql
-- 标量子查询(返回单个值)
SELECT name FROM employees 
WHERE salary > (SELECT AVG(salary) FROM employees);

-- IN子查询(返回一列值)
SELECT name FROM employees 
WHERE department_id IN (SELECT id FROM departments WHERE location = 'New York');

-- EXISTS子查询(检查是否存在)
SELECT name FROM employees e
WHERE EXISTS (SELECT 1 FROM departments d WHERE d.id = e.department_id AND d.budget > 1000000);
```

### 2. FROM子句中的子查询(派生表)

```sql
SELECT dept_name, avg_salary
FROM (SELECT d.name AS dept_name, AVG(e.salary) AS avg_salary
      FROM departments d JOIN employees e ON d.id = e.department_id
      GROUP BY d.name) AS dept_stats
WHERE avg_salary > 50000;
```

### 3. SELECT子句中的子查询

```sql
SELECT e.name, 
       e.salary,
       (SELECT AVG(salary) FROM employees WHERE department_id = e.department_id) AS dept_avg_salary
FROM employees e;
```

## 三、关联子查询

关联子查询是指子查询引用了外部查询的列。

```sql
-- 找出比部门平均工资高的员工
SELECT e1.name, e1.salary
FROM employees e1
WHERE salary > (SELECT AVG(salary) 
                FROM employees e2 
                WHERE e2.department_id = e1.department_id);
```

## 四、常用子查询场景

1. **TOP N问题**：
   ```sql
   -- 找出工资前三高的员工
   SELECT name, salary
   FROM employees e1
   WHERE (SELECT COUNT(DISTINCT salary) 
          FROM employees e2 
          WHERE e2.salary > e1.salary) < 3
   ORDER BY salary DESC;
   ```

2. **比较运算**：
   ```sql
   -- 找出工资高于经理的员工
   SELECT e.name
   FROM employees e
   WHERE salary > (SELECT salary FROM employees m WHERE m.id = e.manager_id);
   ```

3. **存在性检查**：
   ```sql
   -- 找出有订单的客户
   SELECT c.name
   FROM customers c
   WHERE EXISTS (SELECT 1 FROM orders o WHERE o.customer_id = c.id);
   ```

## 五、子查询与JOIN的选择

- 当需要从子查询结果中获取多个列时，通常使用JOIN更高效
- 当只需要检查存在性或比较单个值时，子查询通常更简洁

## 六、性能注意事项

1. 关联子查询可能性能较差，考虑重写为JOIN
2. 在WHERE子句中使用IN或EXISTS时，EXISTS通常对大表性能更好
3. 考虑使用临时表或CTE(Common Table Expression)替代复杂子查询
